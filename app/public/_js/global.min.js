"use strict";function toggleMenu(){var e=0,t=$("#mobi_menu").height()+e,n=Math.abs(parseFloat($("#panel").css("bottom"))),r=n==0?"-"+t+"px":0,i=n==t?t:0;$("#panel").animate({bottom:r});$(".content_container").animate({})}function viewRotate(){var e=$("#iframe_view"),t=e.css("width"),n=e.css("height");e.animate({width:n,height:t})}function loadTemplate(e,t,n,r){var i,s,o="_hbs/"+t+".hbs",u=$(e);$.ajax({url:o,cache:!0,success:function(t){i=t;s=Handlebars.compile(i);u=$(e);switch(r){case"append":u.append(s(n));break;case"prepend":u.prepend(s(n));break;case"replace":u.replaceWith(s(n));$('input[name="idx"]').val(parseFloat(u.attr("id")));break;default:u.html(s(n))}}})}var storage,timer,cards,mobi,timesheet,modal,window_timer=0;storage={check:function(e){return localStorage[e]?!0:!1},set:function(e,t){localStorage.setItem(e,JSON.stringify(t))},get:function(e){return JSON.parse(localStorage.getItem(e))},"delete":function(e){localStorage.removeItem(e)}};timer={cur:"",idx:0,init:function(){},tmr:function(){return{date:timer.timerDate(),hr:"0",min:"00",sec:"00"}},get:function(){var e=mobi.sites.get().cards[timer.idx].timer;return e[e.length-1]},set:function(e){var t=mobi.sites.get(),n=t.cards[timer.idx].timer.length-1;t["cards"][timer.idx].timer[n]["date"]==timer.timerDate()?t.cards[timer.idx].timer[n]=e:t.cards[timer.idx].timer.push(timer.tmr());storage.set(mobi.site,t)},timerDate:function(){var e=new Date,t=e.getDate(),n=e.getMonth()+1,r=e.getFullYear();return n+"-"+t+"-"+r},timerCheckDate:function(e){var t=e==timerDate()?!0:!1;return t},start_stop:function(e){var t="&plus;",n=$("#"+e+" .start_stop");if(n.hasClass("start")){$(".start_stop").removeClass("stop",function(){$(this).addClass("start").html("&plus;")});timer.cur=e;timer.idx=parseFloat(e);timer.get();timer.start();t="&times;"}else timer.stop();n.toggleClass("start").toggleClass("stop").html(t)},start:function(){timer.stop();var e=$("#"+this.cur+" > input"),t=timer.get();t.hr=parseFloat(t.hr);t.min=parseFloat(t.min);t.sec=parseFloat(t.sec);t.sec++;if(t.sec==60){t.sec=0;t.min++}if(t.min==60){t.min=0;t.hr++}t.hr=t.hr;t.min=t.min<10?"0"+t.min:t.min;t.sec=t.sec<10?"0"+t.sec:t.sec;e.val(t.hr+":"+t.min+":"+t.sec);timer.set(t);window_timer=setTimeout("timer.start()",1e3)},stop:function(){window.clearTimeout(window_timer)},reset:function(){}};cards={init:function(){cards.list();cards.cardSortable("#card_list");$('button[data-action="delete"]').on("click",cards.delete)},cardSortable:function(e){var t;$(e).sortable({revert:200,tolerance:"pointer",start:function(e,n){timer.stop();t=$("#"+n.item[0].id);t.addClass("dragging")},stop:function(e,n){t.removeClass("dragging");cards.cardSort(t)}});$(e).disableSelection()},cardSort:function(e){var t=[],n=mobi.sites.get(),r=n.cards,i=parseFloat($(e).attr("id"));console.log(e);$("#card_list li").each(function(){console.log("list loop: "+r[parseFloat(this.id)]);t.push(r[parseFloat(this.id)])});n.cards=t;storage.set(mobi.site,n);cards.list()},cardBlank:function(){return{title:"",due:"",issue:"",status:"",desc:"",timer:[timer.tmr()],checklist:[]}},cardScroll:function(e,t){var n=this.id,r=$("#mobi_menu_cards").width(),i=$("#card_list"),s=i.scrollLeft(),o=i.width(),u=411,a=!1,f;switch(n){case"cards_scroll_l":f=Math.abs(s)-u;break;case"cards_scroll_r":f=Math.abs(s+u)}i.animate({scrollLeft:f})},get:function(){return mobi.sites.get().cards},list:function(){timer.stop();loadTemplate("#card_list","card",mobi.sites.get(),"insert")},create:function(e){var t,n=$("#add_card").attr("data-state"),r=$("#card_list"),i;switch(n){case"add":t="close";$("#add_card").html("&times;");loadTemplate("#card_list","card-form",cards.cardBlank(),"prepend");break;case"close":t="add";$("#add_card").html("&plus;");$("#card_form").parent().fadeOut().remove()}$("#add_card").attr("data-state",t)},add:function(e){var t=mobi.sites.get(),n=t.cards;n.reverse();n.push(e);n.reverse();t.cards=n;storage.set(mobi.site,t)},update:function(e,t){var n=mobi.sites.get(),r=t;r.timer=n.cards[e].timer;n.cards[e]=r;storage.set(mobi.site,n)},save:function(){var e=mobi.sites.get(),t=$('#card_form [name="idx"]').val(),n={title:$('#card_form [name="title"]').val(),due:$('#card_form [name="due"]').val(),status:$('#card_form [name="status"]').val(),desc:$('#card_form [name="desc"]').val().replace(/\n/g,"<br />"),issue:$('#card_form [name="issue"]').val(),checklist:[],timer:[]};n.timer.push(timer.tmr());e.cards.length&&t!="new"&&(n.checklist=e.cards[t].checklist);if(n.title){if(t=="new"){this.add(n);this.create()}else this.update(t,n);cards.list()}},edit:function(e){var t=mobi.sites.get().cards[e];loadTemplate("#"+e+"-card","card-form",t,"replace")},"delete":function(e){var t=mobi.sites.get(),n=$("#"+e+"-card");t.cards.splice(e,1);if(confirm("are you sure")){storage.set(mobi.site,t);n.hide(175,function(){n.remove()})}},archive:function(){},menu:function(e){var t=$("#"+e),n=t.height()-18,r=Math.abs(parseFloat(t.css("bottom"))),i=r==0?"-"+n+"px":0;t.animate({bottom:i})},checklist:{get:function(){},view:function(e,t){$(t).toggleClass("active");var n="#"+e+"-checklist";$(n+" > div").animate({width:"toggle"})},list:function(e){var t=mobi.sites.get(),n=t.cards[e],r="";for(var i in n.checklist)r+='<li class="check-item"><span class="check-done icon-unchecked"></span><span class="check-text">'+n.checklist[i].text+"</span></li>";$("#"+e+"-card .card_options_menu .card-checklist .tasks-count").html(n.checklist.length);$("#"+e+"-checklist > div .check-list").html(r).toggleCheckListButtons()},checklistAdd:function(e,t,n){var r=mobi.sites.get(),i=r.cards[e].checklist,s={done:t,text:n};i.reverse();i.push(s);i.reverse();r.cards[e].checklist=i;storage.set(mobi.site,r);cards.checklist.list(e)},checklistSave:function(e){var t=$(e).data("index"),n=$("#"+t+'-card .check-form-container [name="checklist-done"]'),r=$("#"+t+'-card .check-form-container [name="checklist-item"]');console.log("chkVal");console.log(r.val().length);if(r.val()!=="undefined"&&r.val().length){cards.checklist.checklistAdd(t,n.val(),r.val());r.val("");cards.checklist.list(t)}},checklistSortable:function(){$(".check-list").sortable({revert:200,tolerance:"pointer",start:function(e,t){$(this).addClass("dragging")},stop:function(){$(this).removeClass("dragging")}});$(".check-list").disableSelection()},checklistSort:function(e,t){var n=[],r=mobi.sites.get()}}};mobi={site:"",init:function(){redmine.init();mobi.site=$("#iframe_view").attr("src");mobi.sites.init();mobi.devices.display();mobi.devices.view(mobi.devices.get());mobi.history.init();cards.init();loadTemplate("#settings_panel","settings",mobi.sites.get().settings,"insert");mobi.sites.list()},sites:{init:function(){this.set(mobi.site)},get:function(){return storage.get(mobi.site)},set:function(e){var t=storage.get("sites"),n={url:e,title:e,desc:e,cards:[],statuses:[{name:"to-do",color:"red"},{name:"in-progress",color:"yellow"},{name:"on-hold",color:"green"},{name:"complete",color:"darkgray"}],settings:{red_url:"",red_key:""}};storage.check(e)||storage.set(e,n)},list:function(){var e=localStorage.length,t=["url_history","view"],n=[];for(var r=0;r<e;r++){var i=localStorage.key(r);t.indexOf(i)==-1&&n.push(storage.get(localStorage.key(r)))}return n},global_view:function(){var e=mobi.sites.list();loadTemplate("#global_view","global",e,"insert")}},devices:{list:{fullscreen:{width:"100%",height:"100%"},desktop:{width:"1600px",height:"850px"},ipad:{width:"1024px",height:"768px"},iphone5:{width:"320px",height:"568px"},iphone4:{width:"320px",height:"480px"},galaxy:{width:"360px",height:"640px"},droidtab:{width:"1280px",height:"800px"}},get:function(){var e=storage.get("view");e||(e="fullscreen");return e},active:function(e){$("#devices ul li").removeClass("active");$("#"+e).attr("class","active");storage.set("view",e)},display:function(){var e="",t=mobi.devices.list;for(var n in t)e+='<li id="'+n+'"><button data-view="'+n+'">'+n+"</button></li>";$("#devices ul").html(e)},view:function(e){var t=e;t||storage.set("view","fullscreen");this.active(t);var n=this.list[t],r=$(".content_container");t=="fullscreen"?r.addClass("fullscreen"):r.removeClass("fullscreen");$("#iframe_view").animate({width:n.width,height:n.height})}},history:{init:function(){var e=storage.get("url_history"),t={urls:[]};t.urls.push(mobi.site);if(!e){e=t;storage.set("url_history",t)}mobi.history.setTemplate()},set:function(e){var t=mobi.history.get(),n=t.urls.indexOf(e);n!=-1&&t.urls.splice(n,1);t.urls.push(e);storage.set("url_history",t)},setTemplate:function(){var e=mobi.history.get();e.urls.reverse();loadTemplate("#history_panel","history",e,"insert")},get:function(){return storage.get("url_history")},go:function(e){$("#history_panel").fadeOut("fast");mobi.go(e)}},go:function(e){mobi.site=e;mobi.sites.init();mobi.history.set(e);mobi.history.setTemplate();cards.init();$("#url_input").blur().val(e);$("#iframe_view").attr("src",e)},refresh:function(){this.go(mobi.site)}};timesheet={close:function(){$("#timesheet").fadeOut("fast")},view:function(e){var t=storage.get(mobi.site),n=t.cards[e].timer;$("#timesheet").fadeIn("fast");loadTemplate("#timesheet","timesheet",n)}};modal={show:function(){this.loading();$("#modal").fadeIn("fast")},hide:function(){$("#modal").fadeOut("fast",function(){$("#modal > div").hide()})},loading:function(){$("#modal_loading").toggle()},err:function(e){this.loading();$("#modal_error p").html(e);$("#modal_error").show();$("#modal_error p").html(e)}};$(function(){$(document).keypress(function(e){function n(e){mobi.devices.view(e)}var t;switch(e.which){case 8710:toggleMenu();break;case 730:t=Math.abs(parseFloat($("#panel").css("bottom")));t&&toggleMenu();cards.create();break;case 186:n("fullscreen");break;case 161:n("desktop");break;case 8482:n("ipad");break;case 163:n("iphone5");break;case 162:n("iphone4");break;case 8734:n("galaxy");break;case 167:n("droidtab");break;case 171:viewRotate()}});$("#redmine_issue, #timesheet").draggable({containment:"parent"});$("#rotate_iframe").on("click",function(){viewRotate()});$("#frame_reload").on("click",function(e){e.preventDefault();mobi.refresh()});$(".panel-menu-button").on("click",function(e){var t,n,r;e.preventDefault();Math.abs(parseFloat($("#panel").css("bottom")))&&toggleMenu();t=$(this).data("id"),n=$(".panel-menu"),r=$("#mobi_menu");n.each(function(){$(this).is(":visible")&&$(this).attr("id")!=t&&n.hide()});$("#"+t).fadeToggle("fast")});$("#menu_button").on("click",toggleMenu);$("#url_form").submit(function(e){var t;e.preventDefault();t=$("#url_input").val();mobi.go(t);cards.list()});$("#modal").on("click",function(){modal.hide()});mobi.init();$("#add_card").on("click",cards.create);$("#devices button").on("click",function(e){e.preventDefault();mobi.devices.view($(this).data("view"))});$(".history_url a").on("click",function(e){e.preventDefault();$("#history_panel").fadeOut();mobi.go($(this).data("url"))});$("#redmine_issue .close_issue").on("click",redmine.closeIssue)});