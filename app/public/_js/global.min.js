"use strict";function panelPos(){return Math.abs(parseFloat($("#panel").css("bottom")))}function toggleMenu(){var e=0,t=$("#mobi_menu").height()+e,n=Math.abs(parseFloat($("#panel").css("bottom"))),r=n==0?"-"+t+"px":0,i=n==t?t:0;$("#panel").animate({bottom:r});$(".content_container").animate({})}function viewRotate(){var e=$("#iframe_view"),t=e.css("width"),n=e.css("height");e.animate({width:n,height:t})}function loadTemplate(e,t,n,r){var i,s,o="_hbs/"+t+".hbs",u=$(e);$.ajax({url:o,cache:!0,success:function(t){i=t;s=Handlebars.compile(i);u=$(e);switch(r){case"append":u.append(s(n));break;case"prepend":u.prepend(s(n));break;case"replace":u.replaceWith(s(n));$('input[name="idx"]').val(parseFloat(u.attr("id")));break;default:u.html(s(n))}}})}function statusTime(){var e=new Date,t=e.getHours(),n=e.getMinutes(),r=t>=12?"p":"a",i;t=t?t%12:12;n=n<10?"0"+n:n;i=t+":"+n+r;$("#status-time").text(i)}var window_timer=0,remote_site="",storage={check:function(e){return localStorage[e]?!0:!1},set:function(e,t){localStorage.setItem(e,JSON.stringify(t))},get:function(e){return JSON.parse(localStorage.getItem(e))},"delete":function(e){localStorage.removeItem(e)}},timer={cur:"",idx:0,init:function(){},tmr:function(){return{date:timer.timerDate(),hr:"0",min:"00",sec:"00"}},get:function(){return cards.cardList[timer.idx].timer},set:function(e,t){var n=timer.get();switch(t){case"new":n.splice(0,0,e);break;case"update":n[0]=e}cards.cardList[timer.idx].timer=n;cards.cardStorage()},timerDate:function(){var e=new Date,t=e.getDate(),n=e.getMonth()+1,r=e.getFullYear();return n+"-"+t+"-"+r},timerCheckDate:function(e){var t=e==timerDate()?!0:!1;return t},start_stop:function(e){var t="&plus;",n=$("#"+e+" .start_stop"),r=n.parent().parent().parent();$(".card.card-active").removeClass("card-active");if(n.hasClass("start")){$(".start_stop").removeClass("stop",function(){$(this).addClass("start").html("&plus;")});timer.cur=e;timer.idx=parseFloat(e);timer.get();timer.start();t="&times;";r.addClass("card-active")}else timer.stop();n.toggleClass("start").toggleClass("stop").html(t)},start:function(){timer.stop();var e=$("#"+this.cur+" > input"),t="update",n=timer.get()[0];if(n.date!=timer.timerDate()){t="new";n=timer.tmr()}n.hr=parseFloat(n.hr);n.min=parseFloat(n.min);n.sec=parseFloat(n.sec);n.sec++;if(n.sec==60){n.sec=0;n.min++}if(n.min==60){n.min=0;n.hr++}n.hr=n.hr;n.min=n.min<10?"0"+n.min:n.min;n.sec=n.sec<10?"0"+n.sec:n.sec;timer.set(n,t);e.val(n.hr+":"+n.min+":"+n.sec);window_timer=setTimeout("timer.start()",1e3)},stop:function(){window.clearTimeout(window_timer)},reset:function(){}},cards={init:function(){this.cardList=mobi.sites.get().cards;this.list();console.log(this.cardList);this.cardSortable("#card_list");$('button[data-action="delete"]').on("click",cards.delete)},cardList:"",cardBlank:function(){return{title:"",due:"",issue:"",status:"",desc:"",timer:[timer.tmr()],checklist:[]}},cardStorage:function(){var e=mobi.sites.get();e.cards=cards.cardList;storage.set(mobi.site,e)},cardSortable:function(e){var t;$(e).sortable({revert:200,tolerance:"pointer",start:function(e,n){timer.stop();t=$("#"+n.item[0].id);t.addClass("dragging");$("#checklist").is(":visible")&&checklist.close()},stop:function(e,n){t.removeClass("dragging");cards.cardSort(t)}});$(e).disableSelection()},cardSort:function(e){var t=[],n=parseFloat($(e).attr("id")),r=this.cardList;$("#card_list li").each(function(){t.push(r[parseFloat(this.id)])});this.cardList=t;this.cardStorage();this.list()},list:function(){timer.stop();loadTemplate("#card_list","card",cards.cardList,"insert")},create:function(e){var t,n=$("#add_card").attr("data-state"),r=$("#card_list"),i;switch(n){case"add":t="close";$("#add_card").html("&times;");loadTemplate("#card_list","card-form",cards.cardBlank(),"prepend");break;case"close":t="add";$("#add_card").html("&plus;");$("#card_form").parent().fadeOut().remove()}$("#add_card").attr("data-state",t)},update:function(e,t){var n=t;n.timer=cards.cardList[e].timer;n.checklist=cards.cardList[e].checklist;cards.cardList[e]=n},save:function(){var e=$('#card_form [name="idx"]').val(),t={title:$('#card_form [name="title"]').val(),due:$('#card_form [name="due"]').val(),status:$('#card_form [name="status"]').val(),desc:$('#card_form [name="desc"]').val().replace(/\n/g,"<br />"),issue:$('#card_form [name="issue"]').val(),checklist:[],timer:[]};t.timer.push(timer.tmr());if(t.title){if(e=="new"){cards.cardList.splice(0,0,t);this.create()}else this.update(e,t);cards.cardStorage();cards.list()}},edit:function(e){var t=mobi.sites.get().cards[e];loadTemplate("#"+e+"-card","card-form",t,"replace")},"delete":function(e){var t=$("#"+e+"-card");if(confirm("are you sure")){cards.cardList.splice(e,1);cards.cardStorage();t.hide(175,function(){$(this).remove()})}}},mobi={init:function(){mobi.site="blank.html";mobi.sites.init();mobi.devices.display();mobi.devices.view(mobi.devices.get());mobi.history.init();loadTemplate("#settings_panel","settings",mobi.sites.get().settings,"insert");mobi.sites.list();cards.init();redmine.init()},site:"",sites:{init:function(){this.set(mobi.site)},get:function(){return storage.get(mobi.site)},set:function(e){var t=storage.get("sites"),n={url:e,title:e,desc:e,cards:[],statuses:[{name:"to-do",color:"red"},{name:"in-progress",color:"yellow"},{name:"on-hold",color:"green"},{name:"complete",color:"darkgray"}],settings:{red_url:"",red_key:""}};storage.check(e)||storage.set(e,n)},list:function(){var e=localStorage.length,t=["url_history","view"],n=[];for(var r=0;r<e;r++){var i=localStorage.key(r);t.indexOf(i)==-1&&n.push(storage.get(localStorage.key(r)))}return n},global_view:function(){var e=mobi.sites.list();loadTemplate("#global_view","global",e,"insert")}},devices:{list:{fullscreen:{label:"Fullscreen",icon:"icon-fullscreen",width:"100%",height:"100%",statusbar:{template:"",height:""}},desktop:{label:"Desktop",icon:"icon-desktop",width:"1600px",height:"850px",statusbar:{template:"",height:""}},ipad:{label:"iPad",icon:"icon-apple",width:"1024px",height:"748px",statusbar:{template:"",height:""}},iphone4:{label:"iPhone 4",icon:"icon-apple",width:"320px",height:"460px",statusbar:{template:"",height:""}},iphone5:{label:"iPhone 5",icon:"icon-apple",width:"320px",height:"548px",statusbar:{template:"",height:""}},galaxy:{label:"Galaxy",icon:"icon-android",width:"360px",height:"620px",statusbar:{template:"",height:""}},galaxyt3:{label:"Galaxy Tab 3",icon:"icon-android",width:"1200px",height:"580px",statusbar:{template:"",height:""}}},get:function(){var e=storage.get("view");e||(e="fullscreen");return e},active:function(e){$("#devices ul li").removeClass("active");$("#"+e).attr("class","active");storage.set("view",e)},display:function(){var e="",t=mobi.devices.list;for(var n in t)e+='<li id="'+n+'"><button data-view="'+n+'"><span class="'+t[n].icon+'"></span>'+t[n].label+"</button></li>";$("#devices ul").html(e)},view:function(e){var t=e;t||storage.set("view","fullscreen");this.active(t);var n=this.list[t],r=$(".content_container");t=="fullscreen"?r.addClass("fullscreen"):r.removeClass("fullscreen");$("#status-view").text(n.label);$("#iframe_view").animate({width:n.width,height:n.height})}},history:{init:function(){var e=storage.get("url_history"),t={urls:[]};t.urls.push(mobi.site);if(!e){e=t;storage.set("url_history",t)}mobi.history.setTemplate()},set:function(e){var t=mobi.history.get(),n=t.urls.indexOf(e);n!=-1&&t.urls.splice(n,1);t.urls.push(e);storage.set("url_history",t)},setTemplate:function(){var e=mobi.history.get();e.urls.reverse();loadTemplate("#history_panel","history",e,"insert")},get:function(){return storage.get("url_history")},go:function(e){$("#history_panel").fadeOut("fast");mobi.go(e)}},go:function(e){mobi.site=e;mobi.sites.init();mobi.history.set(e);mobi.history.setTemplate();cards.init();$("#url_input").blur().val(e);$("#iframe_view").attr("src",e)},refresh:function(){statusTime();this.go(mobi.site)}},timesheet={close:function(){$("#timesheet").fadeOut("fast")},view:function(e){var t=cards.cardList[e];$("#timesheet").fadeIn("fast");loadTemplate("#timesheet","timesheet",t)}},checklist={view:function(e,t){var n=$(t),r=cards.cardList[e];r.idx=e;if(t){$(".card-checklist").removeClass("active");$(t).toggleClass("active");$("#checklist").fadeIn("fast")}loadTemplate("#checklist","checklist",r)},done:function(e){var t=$(e),n=t.parent().data("index"),r=t.parent().parent().data("index"),i=cards.cardList[r],s=i.checklist[n],o=s.done==0?1:0;t.toggleClass("icon-unchecked").toggleClass("icon-check").parent().attr("data-done",o);cards.cardList[r].checklist[n].done=o;checklist.checklistCount(r);cards.cardStorage()},close:function(){$(".card-checklist.active").removeClass("active");$("#checklist").fadeOut("fast")},checklistCount:function(e){var t=cards.cardList[e].checklist,n=t.filter(function(e){return e.done==0}).length,r=$("#"+e+"-card .tasks-count");r.html(n)},checklistAdd:function(e,t,n,r){var i=cards.cardList[e].checklist,s={done:t,text:n,priority:r};i.splice(0,0,s);cards.cardList[e].checklist=i;cards.cardStorage();checklist.checklistCount(e);this.view(e,!1)},checklistSave:function(e){var t=$(e).data("index"),n=$('#check-form-container [name="checklist-done"]'),r=$('#check-form-container [name="checklist-item"]'),i=$("#check-priority").text();if(r.val()!=="undefined"&&r.val().length){checklist.checklistAdd(t,n.val(),r.val(),i);r.val("");checklist.view(t,!1)}},checklistSortable:function(){$("#check-list-items").sortable({revert:200,tolerance:"pointer",start:function(e,t){$(this).addClass("dragging")},stop:function(){$(this).removeClass("dragging");checklist.checklistSort()}});$("#check-list-items").disableSelection()},checklistSort:function(){var e=[],t=$("#check-list-items").data("index");$("#check-list-items li").each(function(){e.push(cards.cardList[t].checklist[$(this).data("index")])});cards.cardList[t].checklist=e;cards.cardStorage()}},modal={show:function(){this.loading();$("#modal").fadeIn("fast")},hide:function(){$("#modal").fadeOut("fast",function(){$("#modal > div").hide()})},loading:function(){$("#modal_loading").toggle()},err:function(e){this.loading();$("#modal_error p").html(e);$("#modal_error").show();$("#modal_error p").html(e)}};$(function(){$(document).keypress(function(e){function t(e){mobi.devices.view(e)}switch(e.which){case 172:e.preventDefault();$("#url_input").focus().select();break;case 8710:e.preventDefault();toggleMenu();break;case 730:e.preventDefault();panelPos()&&toggleMenu();cards.create();break;case 186:t("fullscreen");break;case 161:t("desktop");break;case 8482:t("ipad");break;case 163:t("iphone4");break;case 162:t("iphone5");break;case 8734:t("galaxy");break;case 167:t("droidtab");break;case 171:viewRotate()}});$("#redmine_issue, #timesheet, #checklist").draggable({containment:"parent"});$("#rotate_iframe").on("click",function(){viewRotate()});$("#frame_reload").on("click",function(e){e.preventDefault();mobi.refresh()});$("#frame_history").on("click",function(e){e.preventDefault();panelPos()&&toggleMenu();$("#history_panel").fadeIn()});$("#frame_settings").on("click",function(e){e.preventDefault();panelPos()&&toggleMenu();$("#settings_panel").fadeIn()});$("#menu_button").on("click",toggleMenu);$("#url_form").submit(function(e){e.preventDefault();var t=$("#url_input").val();mobi.go(t);cards.list()});$("#modal").on("click",function(){modal.hide()});mobi.init();$("#add_card").on("click",cards.create);$("#devices button").on("click",function(e){e.preventDefault();mobi.devices.view($(this).data("view"))});$(".history_url a").on("click",function(e){e.preventDefault();$("#history_panel").fadeOut();mobi.go($(this).data("url"))});$("#redmine_issue .close_issue").on("click",redmine.closeIssue)});$(window).on("unload",function(){timer.stop()});