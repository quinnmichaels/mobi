function update_blacklist(){sys.log("Updating blacklist.");blacklist=fs.readFileSync("./blacklist").split("\n").filter(function(e){return e.length}).map(function(e){return RegExp(e)})}function update_iplist(){sys.log("Updating iplist.");iplist=fs.readFileSync("./iplist").split("\n").filter(function(e){return e.length})}function ip_allowed(e){for(i in iplist)if(iplist[i]==e)return!0;return!1}function host_allowed(e){for(i in blacklist)if(blacklist[i].test(e))return!1;return!0}function deny(e,t){e.writeHead(401);e.write(t);e.end()}var http=require("http"),sys=require("sys"),fs=require("fs"),blacklist=[],iplist=[];fs.watchFile("./blacklist",function(){update_blacklist()});fs.watchFile("./iplist",function(){update_iplist()});http.createServer(function(e,t){var n,r,i=e.connection.remoteAddress;if(!ip_allowed(i)){msg="IP "+i+" is not allowed to use this proxy";deny(t,msg);sys.log(msg);return}if(!host_allowed(e.url)){msg="Host "+e.url+" has been denied by proxy configuration";deny(t,msg);sys.log(msg);return}sys.log(i+": "+e.method+" "+e.url);n=http.createClient(80,e.headers.host);r=n.request(e.method,e.url,e.headers);r.addListener("response",function(e){e.addListener("data",function(e){t.write(e,"binary")});e.addListener("end",function(){t.end()});t.writeHead(e.statusCode,e.headers)});e.addListener("data",function(e){r.write(e,"binary")});e.addListener("end",function(){r.end()})}).listen(8080);update_blacklist();update_iplist();