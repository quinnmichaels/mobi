var ConnectManager,debug,http=require("http"),https=require("https"),parseString=require("xml2js").parseString,urlParser=require("url"),util=require("util");events=require("events");exports.Client=function(e){var t,n,r=this;r.options=e||{},r.useProxy=r.options.proxy||!1?!0:!1,r.proxy=r.options.proxy,r.connection=r.options.connection||{},r.mimetypes=r.options.mimetypes||{};this.methods={};t={createProxyPath:function(e){var t=e.host;e.protocol==="https:"&&(t=e.host.indexOf(":")==-1?e.hostname+":443":e.host);return t},createProxyHeaders:function(){var e={};r.proxy.user&&r.proxy.password&&(e["Proxy-Authorization"]="Basic "+(new Buffer([r.proxy.user,r.proxy.password].join(":"))).toString("base64"));return e},createConnectOptions:function(e){debug("connect URL = ",e);var t=urlParser.parse(e),n,i={},s=t.protocol.indexOf(":")==-1?t.protocol:t.protocol.substring(0,t.protocol.indexOf(":")),o=s==="http"?80:443;i={host:t.host.indexOf(":")==-1?t.host:t.host.substring(0,t.host.indexOf(":")),port:t.port===undefined?o:t.port,path:t.path,protocol:s};r.useProxy&&(i.agent=!1);r.options.user&&r.options.password&&(i.auth=[r.options.user,r.options.password].join(":"));r.useProxy&&(i.proxy={host:r.proxy.host,port:r.proxy.port,method:"CONNECT",path:this.createProxyPath(t),headers:this.createProxyHeaders()});if(r.connection&&typeof r.connection=="object")for(var u in r.connection)i[u]=r.connection[u];return i},decodeQueryFromURL:function(e){var t=urlParser.parse(e),n=t.query.substring(1).split("&"),r,i={};for(var s=0;s<n.length;s++){r=n[s].split("=");i[r[0]]=decodeURIComponent(r[1])}return i},encodeQueryFromArgs:function(e){var t="?",n=1;for(var r in e){var i=r+"="+encodeURIComponent(e[r]);n>1&&(i="&".concat(i));t=t.concat(i);n++}return t},parsePathParameters:function(e,t){var n=t;if(!e||!e.path)return t;for(var r in e.path){var i=new RegExp("\\$\\{"+r+"\\}","i");n=n.replace(i,e.path[r])}return n},connect:function(e,t,n,i){var s=this.createConnectOptions(this.parsePathParameters(n,t));s.method=e;debug("options pre connect",s);debug("args = ",n);debug("args.data = ",n.data);if(typeof n=="function")i=n;else if(typeof n=="object"){n.headers&&(s.headers=n.headers);n.data&&(s.data=n.data);debug("options ",s)}r.useProxy?ConnectManager.proxy(s,i):ConnectManager.normal(s,i)},mergeMimeTypes:function(e){e&&typeof e=="object"&&(e.json&&e.json instanceof Array&&e.json.length>0?ConnectManager.jsonctype=e.json:e.xml&&e.xml instanceof Array&&e.xml.length>0&&(ConnectManager.xmlctype=e.xml))}},n=function(e,n){var i=r[n.toLowerCase()];return function(n,r){var s=e;if(typeof n=="function"){r=n;n={}}else if(typeof n=="object"&&n.parameters&&Object.keys(n.parameters).length>0){e+=e.charAt(e.length-1)==="?"?"?":"";s=e.concat(t.encodeQueryFromArgs(n.parameters))}i(s,n,r)}};this.get=function(e,n,r){t.connect("GET",e,n,r)};this.post=function(e,n,r){t.connect("POST",e,n,r)};this.put=function(e,n,r){t.connect("PUT",e,n,r)};this.delete=function(e,n,r){t.connect("DELETE",e,n,r)};this.registerMethod=function(e,t,r){this.methods[e]=new n(t,r)};this.unregisterMethod=function(e){delete this.methods[e]};ConnectManager.on("error",function(e){r.emit("error",e)});t.mergeMimeTypes(r.mimetypes);debug("ConnectManager",ConnectManager)};ConnectManager={xmlctype:["application/xml","application/xml;charset=utf-8"],jsonctype:["application/json","application/json;charset=utf-8"],isXML:function(e){var t=!1;for(var n=0;n<this.xmlctype.length;n++){t=this.xmlctype[n]===e;if(t)break}return t},isJSON:function(e){var t=!1;for(var n=0;n<this.jsonctype.length;n++){t=this.jsonctype[n]===e;if(t)break}return t},proxy:function(e,t){var n=http.request(e.proxy);n.on("connect",function(n,r,i){e.socket=r;var s=[],o=e.protocol=="http"?http:https,u=this;delete e.protocol;var a=o.request(e,function(e){e.on("data",function(e){s.push(e)});e.on("end",function(){var n=s.join(""),r=e.headers["content-type"];u.isXML(r)?parseString(n,function(n,r){t(r,e)}):u.isJSON(r)?t(JSON.parse(n),e):t(n,e)})});e.data&&req.write(typeof e.data=="object"?JSON.stringify(e.data):e.data);a.end()});n.on("error",function(e){self.emit("error",e)});n.end()},normal:function(e,t){var n=[],r=e.protocol==="http"?http:https,i=this;delete e.protocol;debug("options pre connect",e);var s=r.request(e,function(e){e.on("data",function(e){n.push(e)});e.on("end",function(){var r=n.join(""),s=e.headers["content-type"];debug("typeof data es ",typeof r);debug("content-type es",s);i.isXML(s)?parseString(r,function(n,r){t(r,e)}):i.isJSON(s)?t(JSON.parse(r),e):t(r,e)})});s.on("error",function(e){i.emit("error",e)});debug("options data",e.data);e.data&&s.write(typeof e.data=="object"?JSON.stringify(e.data):e.data);s.end()}};util.inherits(exports.Client,events.EventEmitter);util._extend(ConnectManager,events.EventEmitter.prototype);debug=function(){if(!process.env.DEBUG)return;var e=new Date,t=e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()+" [API CLIENT]"+arguments.callee.caller.name+" -> ",n=Array.prototype.slice.call(arguments);n.splice(0,0,t);console.log.apply(console,n)};