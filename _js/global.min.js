"use strict";function toggleMenu(){var e=0,t=$("#mobi_menu").height()+e,n=Math.abs(parseFloat($("#panel").css("bottom"))),r=n==0?"-"+t+"px":0;$("#panel").animate({bottom:r})}function viewRotate(){var e=$("#iframe_view"),t=e.css("width"),n=e.css("height");e.animate({width:n,height:t})}var window_timer=0,storage={check:function(e){return localStorage[e]?!0:!1},set:function(e,t){localStorage.setItem(e,JSON.stringify(t))},get:function(e){return JSON.parse(localStorage.getItem(e))},"delete":function(e){localStorage.removeItem(e)}},loadTemplate=function(e,t,n,r){var i,s,o="_hbs/"+t+".hbs",u=$(e);$.ajax({url:o,cache:!0,success:function(t){i=t;s=Handlebars.compile(i),u=$(e);switch(r){case"append":u.append(s(n));break;case"prepend":u.prepend(s(n));break;default:u.html(s(n))}}})},timer={cur:"",idx:0,tmr:{hr:0,min:0,sec:0},init:function(){},get:function(){var e=mobi.sites.get().cards[timer.idx].timer;timer.tmr=e},set:function(){var e=mobi.sites.get();e.cards[timer.idx].timer=timer.tmr;storage.set(mobi.site,e)},start_stop:function(e){var t="&plus;",n=$("#"+e+" .start_stop");if(n.hasClass("start")){timer.cur=e;timer.idx=parseFloat(e);timer.get();timer.start();t="&times;"}else timer.stop();n.toggleClass("start").toggleClass("stop").html(t)},start:function(){var e=$("#"+this.cur+" > input"),t=timer.tmr.hr?this.tmr.hr+":":"00:",n=timer.tmr.min?this.tmr.min+":":"00:",r=timer.tmr.sec?this.tmr.sec:"00";t=parseFloat(t)>0&&parseFloat(t)<10?"0"+t:t;n=parseFloat(n)>0&&parseFloat(n)<10?"0"+n:n;r=parseFloat(r)>0&&parseFloat(r)<10?"0"+r:r;timer.tmr.sec++;if(timer.tmr.sec==60){timer.tmr.sec=0;timer.tmr.min++}if(timer.tmr.min==60){timer.tmr.min=0;timer.tmr.hr++}e.val(t+n+r);window_timer=setTimeout("timer.start()",1e3)},stop:function(){timer.set();window.clearTimeout(window_timer)},reset:function(){}},cards={init:function(){var e;this.list();$('button[data-action="delete"]').on("click",cards.delete);$("#card_list").sortable({revert:!0,start:function(t,n){e=$("#"+n.item[0].id);e.addClass("dragging")},stop:function(){e.removeClass("dragging");cards.cardSort()}});$("#card_list,#card_list li").disableSelection()},cardBlank:function(){return{title:"",page:"",issue:"",status:"",desc:""}},cardScroll:function(e,t){var n=this.id,r=$("#mobi_menu_cards").width(),i=$("#card_list"),s=i.scrollLeft(),o=i.width(),u=411,a=!1,f;switch(n){case"cards_scroll_l":f=Math.abs(s)-u;break;case"cards_scroll_r":f=Math.abs(s+u)}i.animate({scrollLeft:f})},cardSort:function(e,t){var n=[],r=mobi.sites.get();$("#card_list li").each(function(){n.push(r.cards[parseFloat(this.id)])});r.cards=n;storage.set(mobi.site,r)},get:function(){return mobi.sites.get().cards},list:function(){console.log(mobi.sites.get());loadTemplate("#card_list","card",mobi.sites.get())},create:function(e){var t,n=$("#add_card").attr("data-state"),r=$("#card_list"),i;switch(n){case"add":t="close";$("#add_card").html("&times;");loadTemplate("#card_list","card-form",cards.cardBlank(),"append");$('#card_form input[name="title"]').focus();break;case"close":t="add";$("#add_card").html("&plus;");$("#card_form").parent().fadeOut().remove()}$("#add_card").attr("data-state",t)},add:function(e){var t=mobi.sites.get(),n=t.cards;n.push(e);t.cards=n;storage.set(mobi.site,t)},save:function(){var e={title:$('#card_form [name="title"]').val(),page:$('#card_form [name="page"]').val(),status:$('#card_form [name="status"]').val(),desc:$('#card_form [name="desc"]').val(),issue:$('#card_form [name="issue"]').val(),timer:{hr:0,min:0,sec:0}};if(e.title){this.add(e);this.create();this.list()}},"delete":function(e){var t=mobi.sites.get(),n=$("#"+e+"-card");t.cards.splice(e,1);storage.set(mobi.site,t);n.hide(175,function(){n.remove()})},archive:function(){},menu:function(e){console.log(e);var t=$("#"+e),n=t.height()-18,r=Math.abs(parseFloat(t.css("bottom"))),i=r==0?"-"+n+"px":0;t.animate({bottom:i})}},mobi={init:function(){mobi.site=$("#iframe_view").attr("src");mobi.sites.init();mobi.devices.display();mobi.devices.view(mobi.devices.get());mobi.history.init();cards.init();loadTemplate("#settings_panel","settings",mobi.sites.get().settings)},site:"",sites:{init:function(){this.set(mobi.site)},get:function(){return storage.get(mobi.site)},set:function(e){var t={url:e,title:e,desc:e,cards:[],settings:{red_url:"",red_key:""}};storage.check(e)||storage.set(e,t)}},devices:{list:{fullscreen:{width:"100%",height:"100%"},desktop:{width:"1600px",height:"850px"},ipad:{width:"1024px",height:"768px"},iphone5:{width:"320px",height:"568px"},iphone4:{width:"320px",height:"480px"},galaxy:{width:"360px",height:"640px"},droidtab:{width:"1280px",height:"800px"}},get:function(){var e=storage.get("view");e||(e="fullscreen");return e},active:function(e){$("#devices ul li").removeClass("active");$("#"+e).attr("class","active");storage.set("view",e)},display:function(){var e="",t=mobi.devices.list;for(var n in t)e+='<li id="'+n+'" class=""><div class="'+n+'">'+n+"</div></li>";$("#devices ul").html(e)},view:function(e){var t=e;t||storage.set("view","fullscreen");this.active(t);var n=this.list[t],r=$(".content_container");t=="fullscreen"?r.addClass("fullscreen"):r.removeClass("fullscreen");$("#iframe_view").animate({width:n.width,height:n.height})}},history:{init:function(){var e=storage.get("url_history"),t={urls:[]};t.urls.push(mobi.site);if(!e){e=t;storage.set("url_history",t)}mobi.history.setTemplate()},set:function(e){var t=mobi.history.get(),n=t.urls.indexOf(e);console.log(n);n!=-1&&t.urls.splice(n,1);t.urls.push(e);storage.set("url_history",t)},setTemplate:function(){var e=mobi.history.get();e.urls.reverse();loadTemplate("#history_panel","history",e)},get:function(){return storage.get("url_history")}},go:function(e){mobi.site=e;mobi.sites.init();mobi.history.set(e);mobi.history.setTemplate();cards.init();$("#url_input").blur().val(e);$("#iframe_view").attr("src",e)},refresh:function(){this.go(mobi.site)}},modal={show:function(){this.loading();$("#modal").fadeIn("fast")},hide:function(){$("#modal").fadeOut("fast",function(){$("#modal > div").hide()})},loading:function(){$("#modal_loading").toggle()},err:function(e){this.loading();$("#modal_error p").html(e);$("#modal_error").show();$("#modal_error p").html(e)}};$(function(){$(document).keypress(function(e){function t(e){mobi.devices.view(e)}switch(e.which){case 8710:toggleMenu();break;case 730:var n=Math.abs(parseFloat($("#panel").css("bottom")));n&&toggleMenu();cards.create();break;case 186:t("fullscreen");break;case 161:t("desktop");break;case 8482:t("ipad");break;case 163:t("iphone5");break;case 162:t("iphone4");break;case 8734:t("galaxy");break;case 167:t("droidtab");break;case 171:viewRotate()}});$(".history_url a").on("click",function(e){e.preventDefault();console.log(this);mobi.go($(this).data("url"))});$("#redmine_issue").draggable({containment:"parent"});$("#rotate_iframe").on("click",function(){viewRotate()});$("#frame_reload").on("click",function(e){e.preventDefault();mobi.refresh()});$(".panel-menu-button").on("click",function(e){e.preventDefault();var t=$(this).data("id"),n=$(".panel-menu"),r=$("#mobi_menu");n.each(function(){$(this).is(":visible")&&$(this).attr("id")!=t&&n.hide()});$("#"+t).fadeToggle()});$("#menu_button").on("click",toggleMenu);$("#url_form").submit(function(e){e.preventDefault();var t=$("#url_input").val();mobi.go(t);cards.list()});$("#frame_history").on("click",function(e){e.preventDefault();$("#history_menu").fadeToggle()});$(".history_url").on("click",function(e){e.preventDefault();$("#history_menu").fadeToggle();mobi.go($(this).data("url"))});$("#add_card").on("click",cards.create);$("#devices ul li div").on("click",function(e){e.preventDefault();mobi.devices.view(this.id)});$("#modal").on("click",function(){modal.hide()});$("#redmine_issue .close_issue").on("click",function(){$("#redmine_issue").fadeOut()});$("button.issue_view").on("click",function(){redmine.issue($(this).data("issue"))});$("#redmine_issue .close_issue").on("click",redmine.closeIssue);mobi.init()});